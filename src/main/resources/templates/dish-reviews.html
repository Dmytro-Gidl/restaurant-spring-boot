<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${dish.name}">Dish Reviews</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Use FontAwesome 4.7 so star icons render correctly without extra JS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.93), rgba(0, 0, 0, 0.93)),
            url('/images/saveInPhotoshop.png') no-repeat;
            background-size: cover;
        }

        .review-wrapper {
            max-width: 800px;
            margin: 40px auto;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .review-card {
            position: relative;
            background: #ffffff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #343a40;
        }
        .review-card::before {
            content: "\201C";
            position: absolute;
            top: -10px;
            left: 10px;
            font-family: Georgia, serif;
            font-size: 3rem;
            color: #343a40;
            line-height: 1;
        }
        .review-date {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .star-rating i { color: #FFD700; }

        .pagination { justify-content: center; }
        .pagination .page-link {
            color: #343a40;
            border-color: #343a40;
        }
        .pagination .page-item.active .page-link {
            background-color: #343a40;
            border-color: #343a40;
            color: #fff;
        }
        .sort-select { width: auto; display: inline-block; }
    </style>
</head>
<body>
<div th:replace="fragments/topnav :: navbar"></div>

<div class="page-wrapper bg-gra-02 p-t-130 p-b-100 font-poppins" id="reviewsBackground">
<div class="wrapper wrapper--w860">
<div class="review-wrapper">
    <div class="position-relative mb-3 text-center">
        <a th:href="@{'/menu?pageNo=' + ${menuPage} + '&pageSize=' + ${menuPageSize} + '&sortField=' + ${sortField} + '&sortDir=' + ${sortDir} + '&filterCategory=' + ${filterCategory}}"
           class="text-decoration-none text-dark position-absolute start-0">
            <i class="fa fa-arrow-left me-2"></i>Back to menu
        </a>
        <h2 class="m-0" th:text="${dish.name}">Dish Name</h2>
    </div>
    <div class="text-center mb-3">
        <img th:if="${dish.imageFileName != null}" th:src="@{${dish.getimagePath()}}" class="img-fluid rounded" style="max-width:300px" alt="Dish image">
    </div>
    <div class="d-flex align-items-center mb-4">
        <div class="flex-grow-1 text-center">
            <div class="star-rating mb-2">
            <span th:each="i : ${#numbers.sequence(1,5)}">
                <i th:class="${dish.averageRating >= i ? 'fa fa-star' : 'fa fa-star-o'}"></i>
            </span>
            <span class="ms-2" th:text="${#numbers.formatDecimal(dish.averageRating,1,1)}"></span>
            </div>
        </div>
        <form id="sortForm" method="get" th:if="${reviewPaged.page.content.size() > 0}" class="ms-2">
            <input type="hidden" name="page" value="1"/>
            <input type="hidden" name="size" th:value="${pageSize}"/>
            <input type="hidden" name="sortField" th:value="${sortField}"/>
            <input type="hidden" name="sortDir" th:value="${sortDir}"/>
            <input type="hidden" name="filterCategory" th:value="${filterCategory}"/>
            <select name="sort" class="form-select sort-select" onchange="document.getElementById('sortForm').submit()">
                <option value="new" th:selected="${reviewSort == 'new'}">Newest</option>
                <option value="rating" th:selected="${reviewSort == 'rating'}">Rating high-low</option>
            </select>
        </form>
    </div>

    <div th:if="${reviewPaged.page.content.size() > 0}">
        <div th:each="rev : ${reviewPaged.page}" class="review-card">
            <div>
                <span th:each="i : ${#numbers.sequence(1,5)}">
                    <i th:class="${rev.rating >= i ? 'fa fa-star text-warning' : 'fa fa-star-o text-warning'}"></i>
                </span>
            </div>
            <p class="fw-bold mb-1" th:text="${rev.userName}">User Name</p>
            <p class="review-date" th:text="${#temporals.format(rev.creationDateTime, 'dd MMM yyyy HH:mm')}"></p>
            <p th:if="${rev.comment != null and !#strings.isEmpty(rev.comment)}" class="mt-2 mb-0" th:text="${rev.comment}">Comment</p>
            <form sec:authorize="hasAuthority('ADMIN')" th:method="delete"
                  th:action="@{'/admin/reviews/' + ${rev.id} + '?dishId=' + ${dish.id}}" class="mt-2">
                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
        </div>
        <nav aria-label="Page navigation" th:if="${reviewPaged.paging.totalPages > 1}">
            <ul class="pagination">
                <li class="page-item" th:classappend="${!reviewPaged.paging.isPrevEnabled()? 'disabled' : ''}">
                    <a class="page-link"
                       th:href="@{'/dishes/' + ${dish.id} + '/reviews?page=' + (${reviewPaged.paging.pageNumber - 1}) + '&size=' + ${pageSize} + '&sort=' + ${reviewSort} + '&sortField=' + ${sortField} + '&sortDir=' + ${sortDir} + '&filterCategory=' + ${filterCategory}}"
                       tabindex="-1" th:text="#{pagination.previous}">Previous</a>
                </li>
                <th:block th:each="item : ${reviewPaged.paging.getItems()}">
                    <li class="page-item"
                        th:classappend="${item.index == reviewPaged.paging.pageNumber? 'active' : ''}"
                        th:if="${item.pageItemType.name() == 'PAGE'}">
                        <a class="page-link"
                           th:href="@{'/dishes/' + ${dish.id} + '/reviews?page=' + ${item.index} + '&size=' + ${pageSize} + '&sort=' + ${reviewSort} + '&sortField=' + ${sortField} + '&sortDir=' + ${sortDir} + '&filterCategory=' + ${filterCategory}}"
                           th:text="${item.index}"></a>
                    </li>
                    <li class="page-item disabled" th:if="${item.pageItemType.name() == 'DOTS'}">
                        <a class="page-link" href="#">...</a>
                    </li>
                </th:block>
                <li class="page-item" th:classappend="${!reviewPaged.paging.isNextEnabled()? 'disabled' : ''}">
                    <a class="page-link"
                       th:href="@{'/dishes/' + ${dish.id} + '/reviews?page=' + (${reviewPaged.paging.pageNumber + 1}) + '&size=' + ${pageSize} + '&sort=' + ${reviewSort} + '&sortField=' + ${sortField} + '&sortDir=' + ${sortDir} + '&filterCategory=' + ${filterCategory}}"
                       th:text="#{pagination.next}">Next</a>
                </li>
            </ul>
        </nav>
    </div>
    <div th:unless="${reviewPaged.page.content.size() > 0}" class="text-center">
        <p class="fs-4">No reviews yet, be first to order and review!</p>
    </div>
</div>
</div>
</div>
<script th:inline="javascript">
    document.getElementById('reviewsBackground').addEventListener('click', function (e) {
        const container = document.querySelector('.review-wrapper');
        if (container && !container.contains(e.target)) {
            const params = new URLSearchParams({
                pageNo: [[${menuPage}]],
                pageSize: [[${menuPageSize}]],
                sortField: '[[${sortField}]]',
                sortDir: '[[${sortDir}]]',
                filterCategory: '[[${filterCategory}]]'
            });
            window.location.href = '/menu?' + params.toString();
        }
    });
</script>
</body>
</html>
